#!/bin/sh
### BEGIN INIT INFO
# Provides:          vsock-server
# Required-Start:    $local_fs $network
# Required-Stop:     $local_fs
# Default-Start:     2 3 4 5
# Default-Stop:      0 1 6
# Short-Description: StarryOS vsock command execution server
# Description:       Listens on vsock port 5555 for OEQA test commands
### END INIT INFO

DAEMON=/usr/sbin/vsock-server
NAME=vsock-server
PIDFILE=/var/run/$NAME.pid
LOGFILE=/var/log/$NAME.log

case "$1" in
    start)
        echo "Starting $NAME..."
        if [ -f $PIDFILE ]; then
            echo "$NAME is already running (PID $(cat $PIDFILE))"
            exit 0
        fi
        
        # 确保目录存在
        mkdir -p $(dirname $PIDFILE) $(dirname $LOGFILE)
        
        # 启动 vsock 服务（后台运行）
        start-stop-daemon --start --background --make-pidfile \
            --pidfile $PIDFILE --exec $DAEMON \
            --startas /bin/sh -- -c "exec $DAEMON >> $LOGFILE 2>&1"
        
        echo "$NAME started"
        ;;
        
    stop)
        echo "Stopping $NAME..."
        if [ ! -f $PIDFILE ]; then
            echo "$NAME is not running"
            exit 0
        fi
        
        start-stop-daemon --stop --pidfile $PIDFILE --retry 5
        rm -f $PIDFILE
        echo "$NAME stopped"
        ;;
        
    restart)
        $0 stop
        sleep 1
        $0 start
        ;;
        
    status)
        if [ -f $PIDFILE ]; then
            PID=$(cat $PIDFILE)
            if kill -0 $PID 2>/dev/null; then
                echo "$NAME is running (PID $PID)"
                exit 0
            else
                echo "$NAME is not running (stale PID file)"
                exit 1
            fi
        else
            echo "$NAME is not running"
            exit 1
        fi
        ;;
        
    *)
        echo "Usage: $0 {start|stop|restart|status}"
        exit 1
        ;;
esac

exit 0

