
# StarryOS build policy for Yocto.
#
# This distro is intentionally minimal: it exists mainly to centralize toolchain
# and global policy decisions (e.g. pinned Rust nightly), while keeping recipes
# focused on building individual components.

DISTRO_NAME = "starryos"
DISTRO_VERSION = "starryos.0"
require conf/distro/include/starry-rust-toolchain.inc
require conf/distro/include/starry-sdk-toolchain.inc

# Workaround for user namespace permission issues
# Disable network isolation globally to avoid "Operation not permitted" errors
BB_TASK_IONICE_LEVEL = ""
INHERIT += "network-workaround"

# Bare-metal kernel - no package management needed
# Set to ipk to satisfy image.bbclass parsing, but won't be used
PACKAGE_CLASSES = "package_ipk"

# Skip package installation for bare-metal builds
INHIBIT_PACKAGE_INSTALL = "1"
INHIBIT_PACKAGE_STRIP = "1"

# Bare-metal doesn't need C++ runtime libraries or libc
# gcc-runtime provides libstdc++, which requires dynamic linking
ASSUME_PROVIDED += "libgcc-dev libgcc virtual/${TARGET_PREFIX}compilerlibs"
PREFERRED_PROVIDER_virtual/${TARGET_PREFIX}compilerlibs = "gcc-cross-${TARGET_ARCH}"

# Remove virtual/libc from BASEDEPENDS to prevent gcc-runtime dependency
# tclibc-baremetal.inc already puts virtual/libc in ASSUME_PROVIDED
# but base.bbclass still includes it in BASE_DEFAULT_DEPS
BASEDEPENDS:remove:class-target = "virtual/libc"

# Rust 1.92.0 includes cargo in the rust package
# Mask separate cargo recipe to avoid conflict
BBMASK += "meta-starry/recipes-devtools/cargo/cargo_1.92.0.bb"
BBMASK += "poky/meta/recipes-devtools/cargo/cargo_.*\.bb"

# Use only meta-starry Rust 1.92.0, mask poky's old 1.59.0
BBMASK += "poky/meta/recipes-devtools/rust/rust_1.59.0.bb"
BBMASK += "poky/meta/recipes-devtools/rust/rust-llvm_1.59.0.bb"
BBMASK += "poky/meta/recipes-devtools/rust/libstd-rs_1.59.0.bb"

# Mask poky's rust-common.bbclass to use meta-starry's version
# This is necessary because bbclass files don't follow layer priority
BBMASK += "poky/meta/classes/rust-common.bbclass"

# Pin rust std version to 1.92.0 to silence preferred-version warnings
PREFERRED_VERSION_libstd-rs = "1.92.0"
PREFERRED_VERSION_libstd-rs-dev = "1.92.0"

# StarryOS is #![no_std] kernel - does NOT need libstd-rs target library
# Force RUSTLIB_DEP to empty to override poky's rust-common.bbclass default
# Note: This must be set here in distro conf to take effect before classes load
RUSTLIB_DEP = ""
