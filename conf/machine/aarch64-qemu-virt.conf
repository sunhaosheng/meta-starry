#@TYPE: Machine
#@NAME: aarch64-qemu-virt
#@DESCRIPTION: ARMv8 QEMU virt machine for StarryOS/ArceOS

# Inherit base ARM and QEMU configuration
require conf/machine/include/arm/armv8a/tune-cortexa57.inc
require conf/machine/include/qemu.inc

# ==================== ArceOS/StarryOS Configuration ====================
# Architecture and platform package
ARCEOS_ARCH = "aarch64"
ARCEOS_PLATFORM = "aarch64-qemu-virt"
ARCEOS_PLAT_PACKAGE = "axplat-aarch64-qemu-virt"

# Rust target triple (bare-metal, no OS)
RUST_TARGET = "aarch64-unknown-none-softfloat"

# StarryOS is a bare-metal kernel, no libc needed
PREFERRED_PROVIDER_virtual/kernel = "starry"

# Override kernel image type for bare-metal
KERNEL_IMAGETYPE = "bin"

# Default ArceOS configuration (can be overridden in recipes)
ARCEOS_SMP ?= "4"
ARCEOS_LOG ?= "warn"

# Default Cargo features for QEMU platform
# Enables: virtio-net, virtio-gpu, virtio-input, virtio-socket, PCI bus
# axfeat/defplat: default platform configuration
# axfeat/dwarf: DWARF debug info
# axfeat/smp: SMP support (multi-core)
CARGO_FEATURES ?= "axfeat/defplat axfeat/dwarf axfeat/smp qemu"

# ==================== QEMU Configuration ====================
QB_SYSTEM_NAME = "qemu-system-aarch64"
QB_MACHINE = "-machine virt"
QB_CPU = "-cpu cortex-a57"
QB_SMP = "-smp 4"
QB_MEM = "-m 2048"
QB_OPT_APPEND = "-nographic"
QB_KERNEL_CMDLINE_APPEND = "console=ttyAMA0"

SERIAL_CONSOLES = "115200;ttyAMA0"
