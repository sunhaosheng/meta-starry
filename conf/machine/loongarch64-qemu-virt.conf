#@TYPE: Machine
#@NAME: loongarch64-qemu-virt
#@DESCRIPTION: LoongArch 64-bit QEMU virt machine for StarryOS/ArceOS

# ==================== ArceOS/StarryOS Configuration ====================
# Architecture and platform package
ARCEOS_ARCH = "loongarch64"
ARCEOS_PLAT_PACKAGE = "axplat-loongarch64-qemu-virt"

# Rust target triple (bare-metal, no OS)
RUST_TARGET = "loongarch64-unknown-none-softfloat"

# StarryOS is a bare-metal kernel
PREFERRED_PROVIDER_virtual/kernel = "starry"
# TCMODE = "external-loongarch64-musl"  # 暂时注释，等有工具链再启用

# ==================== LoongArch64 Architecture ====================
# LoongArch tune definitions live under include/loongarch/
require conf/machine/include/loongarch/tune-loongarch.inc
require conf/machine/include/qemu.inc

# The StarryOS LoongArch platform expects a virt-style board with a 16550 UART.
KERNEL_IMAGETYPE = "bin"

SERIAL_CONSOLES ?= "115200;ttyS0"
SERIAL_CONSOLES_CHECK = "${SERIAL_CONSOLES}"

# Minimal tune/pkgarch hints until a full tune lands
TUNE_PKGARCH = "loongarch64"
PACKAGE_EXTRA_ARCHS = "loongarch64"
KERNEL_ARCH = "loongarch"
valid_archs:prepend = "loongarch loongarch64 "

# ==================== QEMU Configuration ====================
# runqemu parameters
QB_SYSTEM_NAME = "qemu-system-loongarch64"
QB_MACHINE = "-machine virt"
QB_CPU ?= "-cpu la464"
QB_SMP ?= "-smp 4"
QB_MEM ?= "-m 2048"
QB_NETWORK_DEVICE = "-device virtio-net-pci,netdev=net0,mac=@MAC@"
QB_TAP_OPT = "-netdev tap,id=net0,ifname=@TAP@,script=no,downscript=no"
QB_ROOTFS_OPT = "-drive id=disk0,file=@ROOTFS@,if=none,format=raw -device virtio-blk-pci,drive=disk0"
QB_SERIAL_OPT = "-serial mon:stdio"
QB_TCPSERIAL_OPT = "-serial tcp:127.0.0.1:@PORT@,server,nowait"
QB_OPT_APPEND = "-device virtio-tablet-pci -device virtio-keyboard-pci"
QB_KERNEL_CMDLINE_APPEND = "console=ttyS0"
