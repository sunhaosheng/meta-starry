BBPATH .= ":${LAYERDIR}"
BBFILES += " \
  ${LAYERDIR}/recipes-*/*/*.bb \
  ${LAYERDIR}/recipes-*/*/*.bbappend \
"

BBFILE_COLLECTIONS += "starry"
BBFILE_PATTERN_starry := "^${LAYERDIR}/"
BBFILE_PRIORITY_starry = "7"

# Export layer directory for use in classes (e.g., for musl-headers)
LAYERDIR_meta-starry = "${LAYERDIR}"

LAYERDEPENDS_starry = "core"
LAYERSERIES_COMPAT_starry = "kirkstone mickledore nanbield scarthgap"

# Build Rust from source instead of using prebuilt binaries
# This enables full control and customization but requires 8-12 hours build time

# rust-native provides both rustc and cargo in a single package
PREFERRED_PROVIDER_cargo-native = "rust-native"
PREFERRED_PROVIDER_rustc-native = "rust-native"
PREFERRED_VERSION_rust = "1.92.0"
PREFERRED_VERSION_rust-native = "1.92.0"

PREFERRED_VERSION_rust-llvm = "1.92.0"
PREFERRED_VERSION_rust-llvm-native = "1.92.0"

# ==================== BBMASK for conflicting poky classes ====================
# meta-starry provides customized versions of these classes for:
# - Precompiled Rust toolchain support (RUSTLIB_DEP="")
# - RUSTC_BOOTSTRAP=1 for bare-metal kernel builds
# - Custom cargo configuration for bare-metal targets
#
# Mask poky's versions to avoid conflicts:
BBMASK += "poky/meta/classes(-recipe)?/rust-common\.bbclass"
BBMASK += "poky/meta/classes(-recipe)?/cargo_common\.bbclass"
BBMASK += "poky/meta/classes(-recipe)?/cargo\.bbclass"
# Note: rust.bbclass and rust-bin.bbclass are not masked as they have different
# names in meta-starry or are not conflicting
